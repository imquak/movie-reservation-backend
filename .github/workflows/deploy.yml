name: Deploy to Production

on:
  push:
    branches: [ "main" ]  # Runs on every push to main
  workflow_dispatch:      # Allows you to run it manually from the Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # 1. Navigate to the project folder
            cd ~/Projects/movie-reservation-backend

            # 2. Pull the latest code from GitHub
            git pull origin main

            # 3. Rebuild and restart the containers
            # We use 'sudo' if your user needs it, or plain docker if you added the user to the group
            docker compose down
            docker compose up -d --build

            # 4. Cleanup unused images to save disk space
            docker image prune -f